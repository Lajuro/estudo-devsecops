name: Feature Branch Security Scan
run-name: ${{ github.actor }} executando scan de seguranÃ§a DevSecOps ğŸš€

env:
  AMBIENTE_ALVO: Producao
  NODE_VERSION: '18'

on:
  push:
    branches: 
      - 'feature/**'
  workflow_dispatch:

jobs:
  security-and-quality:
    name: AnÃ¡lise de SeguranÃ§a e Qualidade
    runs-on: ubuntu-latest
    
    steps:
      # ========================================
      # 1. ANÃLISE CONTEXTUAL
      # ========================================
      - name: ğŸ“‹ Dump do Contexto GitHub
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"

      - name: âœ… ExecuÃ§Ã£o Condicional
        if: github.event_name == 'push' && !contains(github.event.head_commit.message || '', 'Merge pull request')
        run: echo "Pipeline executada em push direto (nÃ£o Ã© merge de PR)"

      # ========================================
      # 2. CHECKOUT (UMA VEZ APENAS)
      # ========================================
      - name: ğŸ“¥ Checkout do CÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # HistÃ³rico completo para anÃ¡lise SonarQube

      # ========================================
      # 3. SETUP NODE.JS (UMA VEZ APENAS)
      # ========================================
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: nodejs_example/package-lock.json

      # ========================================
      # 4. INSTALAÃ‡ÃƒO DE DEPENDÃŠNCIAS (UMA VEZ APENAS)
      # ========================================
      - name: ğŸ“¦ Instalar DependÃªncias
        working-directory: ./nodejs_example
        run: npm ci

      # ========================================
      # 5. INSPEÃ‡ÃƒO DO AMBIENTE
      # ========================================
      - name: ğŸ” InspeÃ§Ã£o do Sistema
        run: |
          echo "==================== INFORMAÃ‡Ã•ES DO SISTEMA ===================="
          echo "Sistema Operacional: $(uname -a)"
          echo "Node Version: $(node -v)"
          echo "NPM Version: $(npm -v)"
          echo "DiretÃ³rio Atual: $(pwd)"
          echo "==============================================================="
          echo ""
          echo "==================== ESTRUTURA DO PROJETO ===================="
          ls -laR
          echo "==============================================================="

      - name: ğŸ“‚ Listar Arquivos do Projeto
        run: |
          echo "Listando arquivos (respeitando .gitignore)..."
          if [ -f .listignore ]; then
            echo ".listignore encontrado, usando-o para excluir padrÃµes"
            python3 << 'PY'
          import fnmatch,os
          patterns=[l.strip() for l in open('.listignore') if l.strip() and not l.strip().startswith('#')]
          for root,dirs,files in os.walk('.'):
              for name in files:
                  rel=os.path.relpath(os.path.join(root,name),'.')
                  if rel=='.':
                      continue
                  skip=False
                  for p in patterns:
                      if fnmatch.fnmatch(rel,p) or fnmatch.fnmatch(os.path.join('/',rel),p):
                          skip=True
                          break
                  if not skip:
                      print(rel)
          PY
          elif [ -d .git ]; then
            echo ".git encontrado, usando git ls-files"
            git ls-files -z --cached --others --exclude-standard | xargs -0 -n1
          else
            echo "Listando todos os arquivos"
            find . -path './.git' -prune -o -print
          fi

      # ========================================
      # 6. VERACODE PIPELINE SCAN (SAST)
      # ========================================
      - name: ğŸ“¦ Criar Pacote para AnÃ¡lise
        working-directory: ./nodejs_example
        run: |
          echo "Criando pacote para anÃ¡lise Veracode..."
          mkdir -p ../veracode-artifacts
          zip -r ../veracode-artifacts/app.zip . -x "node_modules/*" ".git/*" "*.md"
          echo "Pacote criado com sucesso!"
          ls -lh ../veracode-artifacts/

      - name: ğŸ”’ Veracode Pipeline Scan (SAST)
        id: veracode-pipeline-scan
        uses: veracode/veracode-pipeline-scan-action@v1.0.12
        with:
          vid: ${{ secrets.VERACODE_API_ID }}
          vkey: ${{ secrets.VERACODE_API_KEY }}
          file: "veracode-artifacts/app.zip"
          fail_build: false
          summary_output: true
          summary_output_file: veracode-pipeline-summary.txt
          json_output: true
          json_output_file: veracode-pipeline-results.json
          filtered_json_output_file: veracode-pipeline-filtered.json
        continue-on-error: true

      - name: ğŸ“Š RelatÃ³rio Pipeline Scan
        if: always()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          Veracode Pipeline Scan ConcluÃ­do                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          if [ -f veracode-pipeline-summary.txt ]; then
            echo ""
            echo "=== RESUMO DOS RESULTADOS ==="
            cat veracode-pipeline-summary.txt
          else
            echo "âš ï¸ Arquivo de resumo nÃ£o encontrado"
          fi

      # ========================================
      # 7. VERACODE SCA (SOFTWARE COMPOSITION ANALYSIS)
      # ========================================
      - name: ğŸ›¡ï¸ Veracode SCA Scan
        id: veracode-sca
        env:
          SRCCLR_API_TOKEN: ${{ secrets.SRCCLR_API_TOKEN }}
        uses: veracode/veracode-sca@v2.1.10
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          create-issues: false
          path: ./nodejs_example
          fail-on-cvss: 7
          quick: false
        continue-on-error: true

      - name: ğŸ“Š RelatÃ³rio SCA
        if: always()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          Veracode SCA Scan ConcluÃ­do                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          if [ -n "${{ steps.veracode-sca.outputs.scan-url }}" ]; then
            echo "ğŸ”— RelatÃ³rio Completo: ${{ steps.veracode-sca.outputs.scan-url }}"
          else
            echo "âš ï¸ URL do relatÃ³rio nÃ£o disponÃ­vel"
          fi

      # ========================================
      # 8. UPLOAD DOS RESULTADOS COMO ARTEFATOS
      # ========================================
      - name: ğŸ“¤ Upload Resultados Veracode
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: veracode-scan-results
          path: |
            veracode-pipeline-results.json
            veracode-pipeline-filtered.json
            veracode-pipeline-summary.txt
            veracode-artifacts/app.zip
            scaResults.txt
            scaResults.json
          retention-days: 30
          if-no-files-found: warn

      # ========================================
      # 9. CRIAR PULL REQUEST AUTOMÃTICO PARA DEVELOP
      # ========================================
      - name: ğŸ”€ Criar Pull Request para Develop
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branchName = context.ref.replace('refs/heads/', '');
            
            // Verifica se Ã© uma branch feature
            if (!branchName.startsWith('feature/')) {
              core.info('Branch nÃ£o Ã© feature/*, pulando criaÃ§Ã£o de PR');
              return;
            }
            
            core.info(`Branch atual: ${branchName}`);
            core.info('Criando Pull Request para develop...');
            
            try {
              // Verifica se jÃ¡ existe um PR aberto
              const { data: existingPRs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: `${context.repo.owner}:${branchName}`,
                base: 'develop',
                state: 'open'
              });
              
              if (existingPRs.length > 0) {
                core.info(`âœ“ Pull Request jÃ¡ existe: ${existingPRs[0].html_url}`);
                core.info('Atualizando comentÃ¡rio com resultados do scan...');
                
                // Adiciona comentÃ¡rio com resultados do scan
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingPRs[0].number,
                  body: `## âœ… Scan de SeguranÃ§a ConcluÃ­do
            
            **Branch:** \`${branchName}\`
            **Commit:** \`${context.sha.substring(0, 7)}\`
            **Workflow:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            ### ğŸ“Š Resultados:
            - âœ… Veracode Pipeline Scan (SAST) - ConcluÃ­do
            - âœ… Veracode SCA - ConcluÃ­do
            
            **Artefatos:** Os resultados detalhados estÃ£o disponÃ­veis nos artefatos do workflow.
            
            ---
            *Scan executado automaticamente em ${new Date().toLocaleString('pt-BR')}*`
                });
                
                return;
              }
              
              // Cria novo PR
              const { data: pr } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸš€ ${branchName.replace('feature/', '')} - Ready for Review`,
                head: branchName,
                base: 'develop',
                body: `## ğŸ”’ Scan de SeguranÃ§a Aprovado
            
            Esta PR foi criada automaticamente apÃ³s a conclusÃ£o bem-sucedida do scan de seguranÃ§a.
            
            ### ğŸ“‹ Detalhes
            - **Branch:** \`${branchName}\`
            - **Commit:** \`${context.sha}\`
            - **Autor:** @${context.actor}
            - **Workflow:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            ### âœ… ValidaÃ§Ãµes de SeguranÃ§a
            - âœ… Veracode Pipeline Scan (SAST) - ConcluÃ­do
            - âœ… Veracode SCA (AnÃ¡lise de DependÃªncias) - ConcluÃ­do
            
            ### ğŸ“¦ Artefatos
            Os resultados detalhados dos scans estÃ£o disponÃ­veis nos artefatos do workflow:
            - \`veracode-pipeline-results.json\` - Resultados completos do Pipeline Scan
            - \`veracode-pipeline-filtered.json\` - Resultados filtrados
            - \`veracode-pipeline-summary.txt\` - Resumo do scan
            - \`scaResults.json\` / \`scaResults.txt\` - Resultados do SCA
            
            ### ğŸ” PrÃ³ximos Passos
            1. Revisar os resultados dos scans nos artefatos
            2. Verificar se hÃ¡ vulnerabilidades crÃ­ticas
            3. Aprovar e fazer merge para \`develop\`
            
            ---
            *PR criada automaticamente em ${new Date().toLocaleString('pt-BR')}*`
              });
              
              core.info(`âœ… Pull Request criado com sucesso: ${pr.html_url}`);
              core.info(`PR #${pr.number}: ${pr.title}`);
              
            } catch (error) {
              if (error.status === 422) {
                core.warning('NÃ£o foi possÃ­vel criar PR - verifique se a branch develop existe');
              } else {
                core.setFailed(`Erro ao criar Pull Request: ${error.message}`);
              }
            }

      # ========================================
      # 10. RELATÃ“RIO FINAL
      # ========================================
      - name: âœ… Pipeline ConcluÃ­da
        if: always()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘       Pipeline DevSecOps Executada com Sucesso          â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  âœ“ AnÃ¡lise de Contexto                                  â•‘"
          echo "â•‘  âœ“ Checkout do CÃ³digo                                   â•‘"
          echo "â•‘  âœ“ InstalaÃ§Ã£o de DependÃªncias                           â•‘"
          echo "â•‘  âœ“ Veracode Pipeline Scan (SAST)                        â•‘"
          echo "â•‘  âœ“ Veracode SCA (AnÃ¡lise de DependÃªncias)               â•‘"
          echo "â•‘  âœ“ Upload de Artefatos                                  â•‘"
          echo "â•‘  âœ“ CriaÃ§Ã£o de Pull Request (se feature/*)               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Verifique o tab 'Summary' para relatÃ³rios detalhados"
          echo "ğŸ“¦ Artefatos disponÃ­veis para download"
          echo "ğŸ”— Veracode Platform: https://web.analysiscenter.veracode.com"
