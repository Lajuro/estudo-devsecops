name: CI/CD Pipeline Completo
run-name: ${{ github.actor }} executando pipeline DevSecOps ğŸš€

env:
  AMBIENTE_ALVO: Producao
  NODE_VERSION: '18'

on:
  push:
    branches: [ main ]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  security-and-quality:
    name: AnÃ¡lise de SeguranÃ§a e Qualidade
    runs-on: ubuntu-latest
    
    steps:
      # ========================================
      # 1. ANÃLISE CONTEXTUAL
      # ========================================
      - name: ğŸ“‹ Dump do Contexto GitHub
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"

      - name: âœ… ExecuÃ§Ã£o Condicional
        if: github.event_name == 'push' && !contains(github.event.head_commit.message || '', 'Merge pull request')
        run: echo "Pipeline executada em push direto (nÃ£o Ã© merge de PR)"

      # ========================================
      # 2. CHECKOUT (UMA VEZ APENAS)
      # ========================================
      - name: ğŸ“¥ Checkout do CÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # HistÃ³rico completo para anÃ¡lise SonarQube

      # ========================================
      # 3. SETUP NODE.JS (UMA VEZ APENAS)
      # ========================================
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: nodejs_example/package-lock.json

      # ========================================
      # 4. INSTALAÃ‡ÃƒO DE DEPENDÃŠNCIAS (UMA VEZ APENAS)
      # ========================================
      - name: ğŸ“¦ Instalar DependÃªncias
        working-directory: ./nodejs_example
        run: npm ci

      # ========================================
      # 5. INSPEÃ‡ÃƒO DO AMBIENTE
      # ========================================
      - name: ğŸ” InspeÃ§Ã£o do Sistema
        run: |
          echo "==================== INFORMAÃ‡Ã•ES DO SISTEMA ===================="
          echo "Sistema Operacional: $(uname -a)"
          echo "Node Version: $(node -v)"
          echo "NPM Version: $(npm -v)"
          echo "DiretÃ³rio Atual: $(pwd)"
          echo "==============================================================="
          echo ""
          echo "==================== ESTRUTURA DO PROJETO ===================="
          ls -laR
          echo "==============================================================="

      - name: ğŸ“‚ Listar Arquivos do Projeto
        run: |
          echo "Listando arquivos (respeitando .gitignore)..."
          if [ -f .listignore ]; then
            echo ".listignore encontrado, usando-o para excluir padrÃµes"
            python3 << 'PY'
          import fnmatch,os
          patterns=[l.strip() for l in open('.listignore') if l.strip() and not l.strip().startswith('#')]
          for root,dirs,files in os.walk('.'):
              for name in files:
                  rel=os.path.relpath(os.path.join(root,name),'.')
                  if rel=='.':
                      continue
                  skip=False
                  for p in patterns:
                      if fnmatch.fnmatch(rel,p) or fnmatch.fnmatch(os.path.join('/',rel),p):
                          skip=True
                          break
                  if not skip:
                      print(rel)
          PY
          elif [ -d .git ]; then
            echo ".git encontrado, usando git ls-files"
            git ls-files -z --cached --others --exclude-standard | xargs -0 -n1
          else
            echo "Listando todos os arquivos"
            find . -path './.git' -prune -o -print
          fi

      # ========================================
      # 6. ANÃLISE SONARQUBE
      # ========================================
      - name: ğŸ”¬ SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v6
        with:
          args: >
            -Dsonar.qualitygate.wait=true
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        continue-on-error: true

      - name: ğŸ” Listar Projetos SonarQube (DiagnÃ³stico)
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const http = require('http');
            const https = require('https');
            
            const sonarToken = process.env.SONAR_TOKEN;
            const sonarUrl = process.env.SONAR_HOST_URL || 'https://sonarcloud.io';
            const isSonarCloud = sonarUrl.includes('sonarcloud.io');
            let sonarOrg = null;
            
            function fetchSonarData(endpoint) {
              return new Promise((resolve, reject) => {
                try {
                  const auth = Buffer.from(`${sonarToken}:`).toString('base64');
                  const url = new URL(endpoint, sonarUrl);
                  const protocol = url.protocol === 'https:' ? https : http;
                  
                  const options = {
                    hostname: url.hostname,
                    port: url.port || (url.protocol === 'https:' ? 443 : 80),
                    path: url.pathname + url.search,
                    method: 'GET',
                    headers: {
                      'Authorization': `Basic ${auth}`,
                      'Accept': 'application/json'
                    }
                  };
                  
                  const req = protocol.request(options, (res) => {
                    let data = '';
                    res.on('data', chunk => data += chunk);
                    res.on('end', () => {
                      try {
                        resolve(JSON.parse(data));
                      } catch (e) {
                        reject(e);
                      }
                    });
                  });
                  
                  req.on('error', reject);
                  req.end();
                } catch (e) {
                  reject(e);
                }
              });
            }
            
            try {
              console.log(`ğŸ“‹ Listando projetos disponÃ­veis no ${isSonarCloud ? 'SonarCloud' : 'SonarQube'}...`);
              
              // Primeiro tenta buscar sem organization
              let projects = await fetchSonarData(`/api/projects/search?ps=100`);
              
              // Se for SonarCloud e retornar vazio, tenta detectar a organization
              if (isSonarCloud && (!projects.components || projects.components.length === 0)) {
                try {
                  const orgs = await fetchSonarData(`/api/organizations/search?member=true&ps=1`);
                  if (orgs.organizations && orgs.organizations.length > 0) {
                    sonarOrg = orgs.organizations[0].key;
                    console.log(`ğŸ¢ Organization detectada: ${sonarOrg}`);
                    projects = await fetchSonarData(`/api/projects/search?organization=${sonarOrg}&ps=100`);
                  }
                } catch (e) {
                  console.log('âš ï¸ NÃ£o foi possÃ­vel detectar organization automaticamente');
                }
              }
              
              if (projects.components && projects.components.length > 0) {
                console.log(`\nâœ… ${projects.components.length} projeto(s) encontrado(s):\n`);
                projects.components.forEach((proj, idx) => {
                  console.log(`${idx + 1}. ${proj.name}`);
                  console.log(`   ğŸ“ Key: ${proj.key}`);
                  console.log(`   ğŸ“Š LastAnalysis: ${proj.lastAnalysisDate || 'Nunca'}\n`);
                });
              } else {
                console.log(`âš ï¸ Nenhum projeto encontrado`);
              }
            } catch (error) {
              console.error(`âŒ Erro ao listar projetos:`, error.message);
            }
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - name: ğŸ“Š Gerar RelatÃ³rio SonarQube Detalhado
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const http = require('http');
            const https = require('https');
            
            const sonarToken = process.env.SONAR_TOKEN;
            const sonarUrl = process.env.SONAR_HOST_URL || 'https://sonarcloud.io';
            const isSonarCloud = sonarUrl.includes('sonarcloud.io');
            let projectKey = null;
            let sonarOrg = null;
            
            function fetchSonarData(endpoint) {
              return new Promise((resolve, reject) => {
                try {
                  const auth = Buffer.from(`${sonarToken}:`).toString('base64');
                  const url = new URL(endpoint, sonarUrl);
                  const protocol = url.protocol === 'https:' ? https : http;
                  
                  const options = {
                    hostname: url.hostname,
                    port: url.port || (url.protocol === 'https:' ? 443 : 80),
                    path: url.pathname + url.search,
                    method: 'GET',
                    headers: {
                      'Authorization': `Basic ${auth}`,
                      'Accept': 'application/json'
                    }
                  };
                  
                  const req = protocol.request(options, (res) => {
                    let data = '';
                    res.on('data', chunk => data += chunk);
                    res.on('end', () => {
                      try {
                        const json = JSON.parse(data);
                        resolve(json);
                      } catch (e) {
                        reject(e);
                      }
                    });
                  });
                  
                  req.on('error', reject);
                  req.end();
                } catch (e) {
                  reject(e);
                }
              });
            }
            
            try {
              console.log(`ğŸ” Conectando ao ${isSonarCloud ? 'SonarCloud' : 'SonarQube'}: ${sonarUrl}`);
              console.log(`ğŸ” Auto-detectando projeto...`);
              
              // Primeiro tenta buscar projetos sem organization
              let projects = await fetchSonarData(`/api/projects/search?ps=100`);
              
              // Se for SonarCloud e retornar vazio, tenta detectar a organization
              if (isSonarCloud && (!projects.components || projects.components.length === 0)) {
                try {
                  const orgs = await fetchSonarData(`/api/organizations/search?member=true&ps=1`);
                  if (orgs.organizations && orgs.organizations.length > 0) {
                    sonarOrg = orgs.organizations[0].key;
                    console.log(`ğŸ¢ Organization detectada: ${sonarOrg}`);
                    projects = await fetchSonarData(`/api/projects/search?organization=${sonarOrg}&ps=100`);
                  }
                } catch (e) {
                  console.log('âš ï¸ NÃ£o foi possÃ­vel detectar organization automaticamente');
                }
              }
              
              if (!projects.components || projects.components.length === 0) {
                throw new Error(`Nenhum projeto encontrado. Execute uma anÃ¡lise primeiro.`);
              }
              
              projectKey = projects.components[0].key;
              console.log(`ğŸ“¦ Projeto encontrado: ${projectKey}`);
              
              console.log(`ğŸ“Š Buscando mÃ©tricas do projeto...`);
              const projectMetrics = await fetchSonarData(`/api/measures/component?component=${projectKey}&metricKeys=bugs,vulnerabilities,code_smells,coverage,duplicated_lines_density,security_rating,reliability_rating,maintainability_rating`);
              
              if (!projectMetrics.component) {
                throw new Error(`Projeto "${projectKey}" nÃ£o encontrado.`);
              }
              
              const measures = (projectMetrics.component.measures || []).reduce((acc, m) => {
                acc[m.metric] = m.value;
                return acc;
              }, {});
              
              console.log(`ğŸ” Buscando issues do projeto...`);
              const issuesResponse = await fetchSonarData(`/api/issues/search?componentKeys=${projectKey}&types=BUG,VULNERABILITY,CODE_SMELL&ps=100`);
              
              const issues = issuesResponse.issues || [];
              console.log(`âœ… ${issues.length} issues encontradas`);
              
              const bugCount = issues.filter(i => i.type === 'BUG').length;
              const vulnCount = issues.filter(i => i.type === 'VULNERABILITY').length;
              const smellCount = issues.filter(i => i.type === 'CODE_SMELL').length;
              
              const severities = issues.reduce((acc, i) => {
                acc[i.severity] = (acc[i.severity] || 0) + 1;
                return acc;
              }, {});
              
              let report = `# ğŸ“‹ RelatÃ³rio de AnÃ¡lise SonarQube\n\n`;
              report += `**Data:** ${new Date().toLocaleString('pt-BR')}\n`;
              report += `**Projeto:** ${projectKey}\n\n`;
              
              report += `## ğŸ“Š MÃ©tricas Gerais\n\n`;
              report += `| MÃ©trica | Valor |\n`;
              report += `|---------|-------|\n`;
              report += `| ğŸ› Bugs | ${measures.bugs || '0'} |\n`;
              report += `| ğŸ”’ Vulnerabilidades | ${measures.vulnerabilities || '0'} |\n`;
              report += `| ğŸ’¡ Code Smells | ${measures.code_smells || '0'} |\n`;
              report += `| ğŸ“ˆ Cobertura de Testes | ${measures.coverage || 'N/A'} |\n`;
              report += `| ğŸ” Linhas Duplicadas | ${measures.duplicated_lines_density || 'N/A'} |\n`;
              report += `| â­ Rating de SeguranÃ§a | ${measures.security_rating || 'N/A'} |\n`;
              report += `| ğŸ¯ Rating de Confiabilidade | ${measures.reliability_rating || 'N/A'} |\n`;
              report += `| ğŸ§¹ Rating de Manutenibilidade | ${measures.maintainability_rating || 'N/A'} |\n\n`;
              
              report += `## ğŸ” Resumo de Issues\n\n`;
              report += `- **Total de Issues:** ${issues.length}\n`;
              report += `- **Bugs:** ${bugCount}\n`;
              report += `- **Vulnerabilidades:** ${vulnCount}\n`;
              report += `- **Code Smells:** ${smellCount}\n\n`;
              
              if (Object.keys(severities).length > 0) {
                report += `### Por Severidade\n`;
                report += `| Severidade | Quantidade |\n`;
                report += `|------------|------------|\n`;
                Object.entries(severities).forEach(([sev, count]) => {
                  const icon = sev === 'BLOCKER' ? 'ğŸ”´' : sev === 'CRITICAL' ? 'ğŸŸ ' : sev === 'MAJOR' ? 'ğŸŸ¡' : sev === 'MINOR' ? 'ğŸ”µ' : 'âšª';
                  report += `| ${icon} ${sev} | ${count} |\n`;
                });
                report += '\n';
              }
              
              if (issues.length > 0) {
                report += `## âš ï¸ Issues Mais Graves\n\n`;
                const sorted = issues
                  .sort((a, b) => {
                    const severityOrder = { BLOCKER: 0, CRITICAL: 1, MAJOR: 2, MINOR: 3, INFO: 4 };
                    return severityOrder[a.severity] - severityOrder[b.severity];
                  })
                  .slice(0, 10);
                
                sorted.forEach((issue, idx) => {
                  const icon = issue.severity === 'BLOCKER' ? 'ğŸ”´' : 
                               issue.severity === 'CRITICAL' ? 'ğŸŸ ' : 
                               issue.severity === 'MAJOR' ? 'ğŸŸ¡' : 
                               issue.severity === 'MINOR' ? 'ğŸ”µ' : 'âšª';
                  const typeIcon = issue.type === 'BUG' ? 'ğŸ›' : 
                                   issue.type === 'VULNERABILITY' ? 'ğŸ”’' : 'ğŸ’¡';
                  
                  const fileName = issue.component ? issue.component.split(':').pop() : 'Desconhecido';
                  
                  report += `\n### ${idx + 1}. ${icon} ${typeIcon} ${issue.message}\n`;
                  report += `- **Arquivo:** \`${fileName}\`\n`;
                  if (issue.line) report += `- **Linha:** ${issue.line}\n`;
                  report += `- **Severidade:** ${issue.severity}\n`;
                  report += `- **Status:** ${issue.status}\n`;
                });
                report += '\n';
              } else {
                report += `## âœ… Nenhuma Issue Encontrada\n\n`;
                report += `Excelente! Seu cÃ³digo nÃ£o possui bugs, vulnerabilidades ou code smells crÃ­ticos.\n\n`;
              }
              
              report += `## ğŸ”— Links Ãšteis\n\n`;
              report += `- [ğŸ”— Abrir no SonarQube](${sonarUrl}/dashboard?id=${projectKey})\n`;
              report += `- [ğŸ“ Issues Completas](${sonarUrl}/issues?id=${projectKey})\n`;
              report += `- [ğŸ“Š MÃ©tricas Detalhadas](${sonarUrl}/component_measures?id=${projectKey})\n\n`;
              
              report += `## ğŸ’¡ RecomendaÃ§Ãµes\n\n`;
              if (vulnCount > 0) {
                report += `âš ï¸ **Prioridade Alta:** Existem ${vulnCount} vulnerabilidade(s) de seguranÃ§a que precisam ser corrigidas imediatamente.\n\n`;
              }
              if (bugCount > 0) {
                report += `ğŸ”§ **AÃ§Ã£o NecessÃ¡ria:** ${bugCount} bug(s) detectado(s). Revisar e corrigir Ã© essencial.\n\n`;
              }
              if (smellCount > 0) {
                report += `âœ¨ **Melhorias:** ${smellCount} code smell(s) encontrado(s). Considere refatorar para melhor qualidade do cÃ³digo.\n\n`;
              }
              if (vulnCount === 0 && bugCount === 0 && smellCount === 0) {
                report += `âœ¨ **ParabÃ©ns!** Seu cÃ³digo estÃ¡ em excelente estado.\n\n`;
              }
              
              fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, report);
              
              console.log('âœ… RelatÃ³rio SonarQube gerado com sucesso!');
            } catch (error) {
              console.error('âŒ Erro ao gerar relatÃ³rio:', error.message);
              
              let errorReport = `# âŒ Erro ao Gerar RelatÃ³rio SonarQube\n\n`;
              errorReport += `**Erro:** ${error.message}\n\n`;
              errorReport += `### ğŸ”§ VerificaÃ§Ãµes NecessÃ¡rias\n\n`;
              errorReport += `1. âœ“ Certifique-se que \`SONAR_TOKEN\` estÃ¡ configurado nos secrets\n`;
              errorReport += `2. âœ“ Verifique se \`SONAR_HOST_URL\` estÃ¡ configurado\n`;
              errorReport += `3. âœ“ Confirme que a anÃ¡lise SonarQube foi executada corretamente\n`;
              errorReport += `4. âœ“ Aguarde alguns minutos apÃ³s a primeira anÃ¡lise\n\n`;
              errorReport += `**URL:** ${sonarUrl}\n`;
              errorReport += `**Token:** ${sonarToken ? 'âœ“ Configurado' : 'âœ— NÃ£o configurado'}\n`;
              
              fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, errorReport);
            }
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      # ========================================
      # 7. ANÃLISE SNYK (SEGURANÃ‡A)
      # ========================================
      - name: ğŸ›¡ï¸ Instalar Snyk CLI
        run: npm install -g snyk

      - name: ğŸ”’ Snyk Security Test
        working-directory: ./nodejs_example
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          echo "==================== SNYK SECURITY SCAN ===================="
          snyk test --severity-threshold=low || echo "âš ï¸ Vulnerabilidades encontradas pelo Snyk"
          echo "=============================================================="
        continue-on-error: true

      - name: ğŸ“¡ Snyk Monitor
        working-directory: ./nodejs_example
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          echo "Enviando resultados para monitoramento contÃ­nuo no Snyk..."
          snyk monitor
        continue-on-error: true

      # ========================================
      # 8. RELATÃ“RIO FINAL
      # ========================================
      - name: âœ… Pipeline ConcluÃ­da
        if: always()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          Pipeline DevSecOps Executada com Sucesso       â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  âœ“ AnÃ¡lise de Contexto                                  â•‘"
          echo "â•‘  âœ“ Checkout do CÃ³digo                                   â•‘"
          echo "â•‘  âœ“ InstalaÃ§Ã£o de DependÃªncias                           â•‘"
          echo "â•‘  âœ“ AnÃ¡lise SonarQube (Qualidade de CÃ³digo)              â•‘"
          echo "â•‘  âœ“ AnÃ¡lise Snyk (Vulnerabilidades)                      â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Verifique o tab 'Summary' para relatÃ³rios detalhados"
          echo "ğŸ”— SonarQube: ${{ secrets.SONAR_HOST_URL }}"
          echo "ğŸ”— Snyk: https://app.snyk.io"
