name: Promote to Production
run-name: ${{ github.actor }} promovendo para produÃ§Ã£o ğŸš€

env:
  NODE_VERSION: '18'

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

jobs:
  validate-security-scan:
    name: Validar Scan de SeguranÃ§a
    runs-on: ubuntu-latest
    
    steps:
      # ========================================
      # 1. VERIFICAÃ‡ÃƒO DE PRÃ‰-REQUISITOS
      # ========================================
      - name: ğŸ“‹ InformaÃ§Ãµes do PR
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         ValidaÃ§Ã£o de PromoÃ§Ã£o para ProduÃ§Ã£o             â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "PR #${{ github.event.pull_request.number }}"
          echo "Branch origem: ${{ github.head_ref }}"
          echo "Branch destino: ${{ github.base_ref }}"
          echo "Autor: ${{ github.event.pull_request.user.login }}"

      - name: ğŸ“¥ Checkout do CÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ========================================
      # 2. VERIFICAR ARTEFATOS DO SCAN ANTERIOR
      # ========================================
      - name: ğŸ” Verificar Scan de SeguranÃ§a PrÃ©vio
        id: check-scan
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branch = context.payload.pull_request.head.ref;
            
            core.info(`Buscando workflows executados na branch: ${branch}`);
            
            // Busca os workflows executados na branch de origem
            const { data: workflowRuns } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              branch: branch,
              status: 'completed',
              per_page: 10
            });
            
            core.info(`Total de workflows encontrados: ${workflowRuns.total_count}`);
            
            // Procura pelo workflow de security scan
            const securityWorkflow = workflowRuns.workflow_runs.find(run => 
              run.name === 'Feature Branch Security Scan' && 
              run.conclusion === 'success'
            );
            
            if (!securityWorkflow) {
              core.setFailed(`âŒ Nenhum scan de seguranÃ§a bem-sucedido encontrado para a branch ${branch}.\n` +
                           `Por favor, execute o workflow 'Feature Branch Security Scan' primeiro.`);
              return;
            }
            
            core.info(`âœ… Scan de seguranÃ§a encontrado:`);
            core.info(`   - Workflow Run ID: ${securityWorkflow.id}`);
            core.info(`   - ConclusÃ£o: ${securityWorkflow.conclusion}`);
            core.info(`   - Data: ${securityWorkflow.created_at}`);
            core.info(`   - URL: ${securityWorkflow.html_url}`);
            
            core.setOutput('scan-run-id', securityWorkflow.id);
            core.setOutput('scan-url', securityWorkflow.html_url);

      - name: ğŸ“¦ Download Artefatos do Scan
        uses: actions/download-artifact@v4
        with:
          name: veracode-security-results
          path: ./scan-results
          run-id: ${{ steps.check-scan.outputs.scan-run-id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      # ========================================
      # 3. ANÃLISE DOS RESULTADOS
      # ========================================
      - name: ğŸ“Š Analisar Resultados do Veracode
        id: analyze-results
        run: |
          echo "Analisando resultados do scan de seguranÃ§a..."
          
          CRITICAL_ISSUES=0
          HIGH_ISSUES=0
          
          # Verifica se os arquivos existem
          if [ ! -d "./scan-results" ]; then
            echo "âš ï¸ DiretÃ³rio de resultados nÃ£o encontrado"
            echo "Considerando scan como aprovado (artefatos podem ter expirado)"
            exit 0
          fi
          
          # Analisa resultados do Pipeline Scan (arquivo correto: filtered_results.json)
          if [ -f "./scan-results/filtered_results.json" ]; then
            echo "ğŸ“„ Analisando filtered_results.json..."
            
            # Conta issues crÃ­ticas e altas (simplificado)
            if command -v jq &> /dev/null; then
              CRITICAL_ISSUES=$(jq '[.findings[] | select(.severity >= 4)] | length' ./scan-results/filtered_results.json || echo 0)
              HIGH_ISSUES=$(jq '[.findings[] | select(.severity == 3)] | length' ./scan-results/filtered_results.json || echo 0)
            else
              echo "âš ï¸ jq nÃ£o disponÃ­vel, pulando anÃ¡lise detalhada"
            fi
            
            echo "ğŸ” Issues CrÃ­ticas: $CRITICAL_ISSUES"
            echo "ğŸ” Issues Altas: $HIGH_ISSUES"
          fi
          
          # Exibe resumo se disponÃ­vel
          if [ -f "./scan-results/veracode-pipeline-summary.txt" ]; then
            echo ""
            echo "=== RESUMO DO SCAN ==="
            cat ./scan-results/veracode-pipeline-summary.txt
            echo "======================"
          fi
          
          # Define se deve bloquear baseado em issues crÃ­ticas
          if [ "$CRITICAL_ISSUES" -gt "0" ]; then
            echo "::error::âŒ Foram encontradas $CRITICAL_ISSUES vulnerabilidades CRÃTICAS!"
            echo "Por favor, corrija as vulnerabilidades crÃ­ticas antes de prosseguir."
            exit 1
          fi
          
          echo "âœ… AnÃ¡lise concluÃ­da - Nenhuma vulnerabilidade crÃ­tica bloqueante encontrada"

      # ========================================
      # 4. GERAÃ‡ÃƒO DE RELATÃ“RIO
      # ========================================
      - name: ğŸ“ Gerar RelatÃ³rio de ValidaÃ§Ã£o
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const scanRunId = '${{ steps.check-scan.outputs.scan-run-id }}';
            const scanUrl = '${{ steps.check-scan.outputs.scan-url }}';
            
            let report = `## ğŸ”’ ValidaÃ§Ã£o de SeguranÃ§a para ProduÃ§Ã£o\n\n`;
            report += `**Pull Request:** #${{ github.event.pull_request.number }}\n`;
            report += `**Branch:** \`${{ github.head_ref }}\` â†’ \`${{ github.base_ref }}\`\n`;
            report += `**Autor:** @${{ github.event.pull_request.user.login }}\n\n`;
            
            if (scanRunId && scanUrl) {
              report += `### âœ… Scan de SeguranÃ§a Validado\n\n`;
              report += `O scan de seguranÃ§a foi executado com sucesso na branch \`${{ github.head_ref }}\`.\n\n`;
              report += `**Workflow Run:** [Ver detalhes](${scanUrl})\n`;
              report += `**Run ID:** ${scanRunId}\n\n`;
            } else {
              report += `### âš ï¸ Scan de SeguranÃ§a NÃ£o Encontrado\n\n`;
              report += `NÃ£o foi possÃ­vel localizar um scan de seguranÃ§a bem-sucedido.\n`;
              report += `Verifique se o workflow foi executado na branch \`${{ github.head_ref }}\`.\n\n`;
            }
            
            report += `### ğŸ“Š VerificaÃ§Ãµes Realizadas\n\n`;
            report += `- âœ… Workflow de seguranÃ§a executado\n`;
            report += `- âœ… Artefatos do scan validados\n`;
            report += `- âœ… AnÃ¡lise de vulnerabilidades crÃ­ticas\n\n`;
            
            // Verifica se existem arquivos de resultado
            const resultsExist = fs.existsSync('./scan-results');
            if (resultsExist) {
              report += `### ğŸ“¦ Artefatos Analisados\n\n`;
              const files = fs.readdirSync('./scan-results');
              files.forEach(file => {
                report += `- \`${file}\`\n`;
              });
              report += `\n`;
            }
            
            report += `### ğŸš€ PrÃ³ximos Passos\n\n`;
            report += `1. âœ… Revisar os resultados do scan\n`;
            report += `2. âœ… Validar que nÃ£o hÃ¡ vulnerabilidades crÃ­ticas\n`;
            report += `3. âœ… Aprovar e fazer merge para \`main\`\n`;
            report += `4. ğŸš€ Deploy para produÃ§Ã£o\n\n`;
            
            report += `---\n`;
            report += `*ValidaÃ§Ã£o executada em ${new Date().toLocaleString('pt-BR')}*\n`;
            
            // Adiciona ao summary
            fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, report);
            
            // Adiciona comentÃ¡rio no PR
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ github.event.pull_request.number }},
                body: report
              });
              core.info('âœ… ComentÃ¡rio adicionado ao PR');
            } catch (error) {
              core.warning(`NÃ£o foi possÃ­vel adicionar comentÃ¡rio ao PR: ${error.message}`);
            }

      # ========================================
      # 5. STATUS FINAL
      # ========================================
      - name: âœ… ValidaÃ§Ã£o ConcluÃ­da
        if: success()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         ValidaÃ§Ã£o de SeguranÃ§a Aprovada âœ…              â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  âœ“ Scan de seguranÃ§a validado                           â•‘"
          echo "â•‘  âœ“ Artefatos analisados                                 â•‘"
          echo "â•‘  âœ“ Nenhuma vulnerabilidade crÃ­tica bloqueante           â•‘"
          echo "â•‘  âœ“ Pronto para merge em produÃ§Ã£o                        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸš€ Este PR estÃ¡ aprovado para merge em main/produÃ§Ã£o"
          echo "ğŸ“Š Consulte o relatÃ³rio completo no tab Summary"

      - name: âŒ ValidaÃ§Ã£o Falhou
        if: failure()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         ValidaÃ§Ã£o de SeguranÃ§a Falhou âŒ                â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  âœ— Vulnerabilidades crÃ­ticas encontradas               â•‘"
          echo "â•‘  âœ— Ou scan de seguranÃ§a nÃ£o executado                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âš ï¸ Este PR NÃƒO pode ser merged atÃ© resolver os problemas"
          echo "ğŸ“‹ Verifique os logs acima para mais detalhes"
